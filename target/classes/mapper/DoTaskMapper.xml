<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.annotation.dao.DoTaskMapper">

    <insert id="insertDoTask2" useGeneratedKeys="true" keyProperty="dtid" parameterType="com.annotation.model.DoTask">
        insert into dotask
          (userid,taskid,contentid,dotime, comptime, dtstatus)
        values
          (#{userid}, #{taskid}, #{contentid},#{dotime,jdbcType=VARCHAR}, #{comptime,jdbcType=VARCHAR},
      #{dtstatus,jdbcType=VARCHAR})
    </insert>

    <select id="countTaskNumByUserid" parameterType="Integer" resultType="Integer">
        select contentid from dotask where userid = #{userid}
    </select>

    <select id="selectTask" parameterType="Integer" resultType="com.annotation.model.DoTask">
         select * from dotask where userid = #{userid} and taskid = #{taskid} and contentid = #{contentid}
    </select>

    <insert id="insertDoTask" useGeneratedKeys="true" keyProperty="dtid" parameterType="com.annotation.model.DoTask" >
        insert into dotask
        <trim prefix="(" suffix=")" suffixOverrides="," >
            <if test="dtid != null" >
                dtid,
            </if>
            <if test="userid != null" >
                userid,
            </if>
            <if test="taskid != null" >
                taskid,
            </if>
            <if test="contentid != null" >
                contentid,
            </if>
            <if test="dotime != null" >
                dotime,
            </if>
            <if test="comptime != null" >
                comptime,
            </if>
            <if test="dtstatus != null" >
                dtstatus,
            </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides="," >
            <if test="dtid != null" >
                #{dtid,jdbcType=INTEGER},
            </if>
            <if test="userid != null" >
                #{userid,jdbcType=INTEGER},
            </if>
            <if test="taskid != null" >
                #{taskid,jdbcType=INTEGER},
            </if>
            <if test="contentid != null" >
                #{contentid,jdbcType=INTEGER},
            </if>
            <if test="dotime != null" >
                #{dotime,jdbcType=VARCHAR},
            </if>
            <if test="comptime != null" >
                #{comptime,jdbcType=VARCHAR},
            </if>
            <if test="dtstatus != null" >
                #{dtstatus,jdbcType=VARCHAR},
            </if>
        </trim>
    </insert>
    <update id="alterDotaskTable">
        ALTER TABLE dotask AUTO_INCREMENT =1
    </update>

    <select id="selectMyPubTask" parameterType="Integer" resultType="com.annotation.model.DoTask">
        select * from dotask where userid = #{userid} and taskid = #{taskid} and contentid = #{contentid}
    </select>


    <resultMap id="myPubDoingTaskInfo" type="com.annotation.model.entity.MyPubTaskByDoing">
        <id column="userid" property="userid"></id>
        <result column="dotime" property="dotime"></result>
        <result column="comptime" property="comptime"></result>
        <result column="dtstatus" property="dtstatus"></result>
        <result column="username" property="username"></result>
        <result column="lastLogInTime" property="lastLogInTime"></result>
        <result column="type" property="type"></result>
        <result column="tid" property="tid"></result>
    </resultMap>

    <select id="selectMyDoingPubTaskInfo" parameterType="Integer" resultMap="myPubDoingTaskInfo">
        select dt.userid,dt.dotime,dt.comptime,dt.dtstatus,
         u.username,u.lastLogInTime,
         t.tid,t.type
         from task t
        INNER join dotask dt on t.tid=dt.taskid
        INNER join user u on u.id=dt.userid
        where dt.taskid=#{taskId}
        ORDER BY u.id
        limit #{curIndex},#{pageSize}
    </select>


    <resultMap id="myPubDoingTaskInfoInst" type="com.annotation.model.entity.MyPubTaskByDoing">
        <id column="userid" property="userid"></id>
        <result column="dotime" property="dotime"></result>
        <result column="comptime" property="comptime"></result>
        <result column="dtstatus" property="dtstatus"></result>
        <result column="username" property="username"></result>
        <result column="lastLogInTime" property="lastLogInTime"></result>
        <result column="type" property="type"></result>
        <result column="tid" property="tid"></result>
    </resultMap>

    <select id="selectMyDoingPubTaskInfoInst" parameterType="Integer" resultMap="myPubDoingTaskInfoInst">
          select dt.user_id userid,dt.dotime,dt.comptime,dt.dtstatus,
      u.username,u.lastLogInTime,
        t.tid,t.type
        from task t
        inner join dt_instance dt on t.tid=dt.task_id
        inner join user u on u.id=dt.user_id
        where dt.task_id=#{taskId}
        ORDER BY u.id
        limit #{curIndex},#{pageSize}
    </select>



    <select id="selectTaskIPartIn"  resultMap="myPubDoingTaskInfo">
        select dt.dotime,dt.comptime,dt.dtstatus,
         u.username,u.lastLogInTime,
         t.tid,t.type,t.userid
         from task t
        INNER join dotask dt on t.tid=dt.taskid
        INNER join user u on u.id=t.userid
        where dt.userid=#{userId} AND dt.dtstatus=#{dtstatus}
        ORDER BY u.id
        limit #{curIndex},#{pageSize}
    </select>


    <select id="selectTaskIPartInInstance"  resultMap="myPubDoingTaskInfo">
        select dt.dotime,dt.comptime,dt.dtstatus,
        u.username,u.lastLogInTime,
        t.tid,t.type,t.userid
        from task t
        INNER join dt_instance dt on t.tid=dt.task_id
        INNER join user u on u.id=t.userid
        where dt.user_id=#{userId} AND dt.dtstatus=#{dtstatus}
        ORDER BY u.id
        limit #{curIndex},#{pageSize}
    </select>

</mapper>